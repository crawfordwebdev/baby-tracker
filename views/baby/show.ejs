<%- include('../partials/html-head') %>
<%- include('../partials/nav') %>

<% if (baby.caregiver.equals(user?.profile._id)) { %>

<% if (baby.unfinishedFeedings.length > 0) { %>
<section>
  <div class="col-lg-8 grid-margin stretch-card">
    <div class="card">
      <div class="card-body">
        <h4 class="card-title">Unfinished Feedings</h4>
        <p class="card-description">
          Please set an end time for your feeds<br>
          Total Unfinished Feedings: <%= baby.unfinishedFeedings.length %> 
        </p>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Finish</th>
                <th>Feed Date</th>
                <th>Feed Type</th>
                <th>Amount</th>
                <th>Start Time</th>
                <th>Update</th>
              </tr>
            </thead>
            <tbody>
              <% baby.unfinishedFeedings.forEach(feeding => { %>
              <tr>
                <td>
                  <form action="/baby/<%= baby._id %>/feeding/<%= feeding._id %>?_method=PUT" method="POST">
                    <input type="hidden" name="endTime" value="<%= todaysDateTimeLocal %>">
                    <button type="submit" class="btn unfinished-item">Finish Feed</button>
                  </form>                    
                </td>
                <td>
                <% if (feeding.date) { %>
                  <div class="data-point"><%= dayjs(feeding.date).format('L') %></div>
                <% } %>
                </td>
                <td>
                <% if (feeding.feedType) { %>
                  <div class="data-point"><%= feeding.feedType %></div>
                <% } %>
                </td>
                <td>
                <% if (feeding.amount) { %>
                  <div class="data-point"><%= feeding.amount %></div>
                <% } %>
                </td>
                <td>
                <% if (feeding.startTime) { %>
                  <div class="data-point"><%= dayjs(feeding.startTime).format('L LT') %></div>
                <% } %>
                </td>
                <td>
                  <a href="/baby/<%= baby._id %>/feeding/<%= feeding._id %>/edit">
                    <button class="btn" type="submit"><i class="fa-solid fa-pen fa-2xl"></i></button>
                  </a>
                </td>
              </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>
<% } %> 

<section>
  <h1>Baby Details</h1>
  <a href="/baby/<%= baby._id %>/addData"><button class="btn">Add Data</button></a>

  <div>Name: <%= baby.name %></div>
  <% if (birthday) { %> 
  <div>Birthday: <%= birthday %></div>
  <% } %> 
  <% if (baby.sex) { %> 
  <div>Sex: <%= baby.sex %></div>
  <% } %> 

  <form action="/baby/<%= baby._id %>/edit" method="GET">
    <button class="btn" type="submit">Edit this baby</button>
  </form>
  <form action="/baby/<%= baby._id %>?_method=DELETE" method="POST">
    <button class="btn" type="submit">Remove this baby</button>
  </form>

</section>

<section>
<% if (baby.feedings.length > 0) { %>
  <div class="col-lg-8 grid-margin stretch-card">
    <div class="card">
      <div class="card-body">
        <h4 class="card-title">Feedings</h4>
        <p class="card-description">
          List of all of your baby's feedings<br>
          Total Feedings: <%= baby.feedings.length %> 
        </p>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Has Ended</th>
                <th>Date</th>
                <th>Feed Type</th>
                <th>Amount</th>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Total Time</th>
                <th>Update</th>
                <th>Delete</th>
              </tr>
            </thead>
            <tbody>
              <% baby.feedings.forEach(feeding => { %>
              <tr>
                <td>
                  <%= feeding.hasEnded %> 
                </td>
                <td>
                <% if (feeding.date) { %>
                  <div class="data-point"><%= dayjs(feeding.date).format('L') %></div>
                <% } %>
                </td>
                <td>
                <% if (feeding.feedType) { %>
                  <div class="data-point"><%= feeding.feedType %></div>
                <% } %>
                </td>
                <td>
                <% if (feeding.amount) { %>
                  <div class="data-point"><%= feeding.amount %></div>
                <% } %>
                </td>
                <td>
                <% if (feeding.startTime) { %>
                  <div class="data-point"><%= dayjs(feeding.startTime).format('L LT') %></div>
                <% } %>
                </td>
                <td>
                <% if (feeding.endTime) { %>
                  <div class="data-point"><%= dayjs(feeding.endTime).format('L LT') %></div>
                <% } %>
                </td>
                <td>
                <% if (feeding.startTime && feeding.endTime) { %>
                  <% const startTime = dayjs(feeding.startTime) %>
                  <% const endTime = dayjs(feeding.endTime) %>
                  <div class="data-point"><%= getHourFormatFromMilliSeconds(endTime.diff(startTime, 'millisecond')).slice(0, 5) %></div>
                <% } %> 
                </td>
                <td>
                  <a href="/baby/<%= baby._id %>/feeding/<%= feeding._id %>/edit">
                    <button class="btn" type="submit"><i class="fa-solid fa-pen fa-2xl"></i></button>
                  </a>
                </td>
                <td>
                  <form action="/baby/<%= baby._id %>/feeding/<%= feeding._id %>?_method=DELETE" method="POST">
                    <button class="btn" type="submit" onclick="return confirm('Are you sure you want to delete this feed?');"><i class="fa-solid fa-delete-left fa-2xl"></i></button>
                  </form>
                </td>
              </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
<% } %> 
</section>

<% } %>
<%- include('../partials/footer') %>